<div class="container">
  <!-- Header section-->
  <div class="gradient-banner">    
    <div class="gradient-overlay"></div>
    <div class="banner-content">
      <h2>Ficha comparativa Sistema General de Participaciones.</h2>
      <p>Consulta y compara la información distribuida entre vigencias y entidades.</p>
    </div>
  </div>

  <!-- Filters section -->
  <div class="filters-section">
    <div class="filters-panel">
      <div class="filters-row">
        <!-- Vigencia a consultar (multi-select) -->
        <div class="p-field vigencia-select">
          <p-floatlabel class="w-full" variant="on">
            <p-select 
              id="vigencia" 
              [options]="infoResume" 
              inputId="vigenciaSelect" 
              [(ngModel)]="selected"
              (onChange)="onVigenciaChange($event)"
              optionValue="id_vigencia"
              optionLabel="vigencia" 
              placeholder="Seleccionar vigencia"
              styleClass="vigencia-select-custom">
            </p-select>
            <label for="vigenciaSelect">Vigencia</label>
          </p-floatlabel>
        </div>

        <!-- Departamento -->
        <div class="p-field department-select">
          <p-floatlabel class="w-full md:w-56" variant="on">
            <p-select 
              id="departamento" 
              [options]="departments" 
              inputId="departamentoSelect"
              [(ngModel)]="departmentSelected"
              (onChange)="onDepartmentChange($event)"
              optionValue="codigo"
              optionLabel="nombre" 
              placeholder="Departamento">
            </p-select>
            <label for="departamentoSelect">Departamento</label>
          </p-floatlabel>
        </div>

        <!-- Municipio -->
        <div class="p-field town-select">
          <p-floatlabel class="w-full md:w-56" variant="on">
            <p-select 
              id="municipio" 
              [options]="towns" 
              inputId="municipioSelect"
              [(ngModel)]="townSelected"
              (onChange)="onTownChange($event)"
              optionValue="codigo_municipio"
              optionLabel="nombre_municipio" 
              placeholder="Municipio"
              [disabled]="!departmentSelected">
            </p-select>
            <label for="municipioSelect">Municipio</label>
          </p-floatlabel>
        </div>

        <!-- Departamento 2 -->
        <div class="p-field department-select">
          <p-floatlabel class="w-full md:w-56" variant="on">
            <p-select 
              id="departamento2" 
              [options]="departments" 
              inputId="departamentoSelect2"
              [(ngModel)]="departmentSelected2"
              (onChange)="onDepartment2Change($event)"
              optionValue="codigo"
              optionLabel="nombre" 
              placeholder="Departamento 2">
            </p-select>
            <label for="departamentoSelect2">Departamento 2</label>
          </p-floatlabel>
        </div>

        <!-- Municipio 2 -->
        <div class="p-field town-select">
          <p-floatlabel class="w-full md:w-56" variant="on">
            <p-select 
              id="municipio2" 
              [options]="towns2" 
              inputId="municipioSelect2"
              [(ngModel)]="townSelected2"
              (onChange)="onTown2Change($event)"
              optionValue="codigo_municipio"
              optionLabel="nombre_municipio" 
              placeholder="Municipio 2"
              [disabled]="!departmentSelected2">
            </p-select>
            <label for="municipioSelect2">Municipio 2</label>
          </p-floatlabel>
        </div>
        <button pButton type="button" 
              icon="pi pi-filter" 
              label="Aplicar" 
              class="p-button-primary"
              (click)="applyFilters()">
        </button>
        <button pButton type="button" 
                icon="pi pi-eraser" 
                label="Limpiar" 
                class="p-button-secondary"
                (click)="clearFilters()">
        </button>
      </div>
    </div>    
  </div>

  <!-- Informative message when no municipalities are selected -->
  <div class="info-message-section" *ngIf="!townSelected || !townSelected2">
    <p-card class="info-card">
      <div class="info-content" style="text-align: center; padding: 2rem;">
        <i class="pi pi-info-circle" style="font-size: 3rem; color: #2196F3; margin-bottom: 1rem;"></i>
        <h3>Seleccione las entidades territoriales a comparar</h3>
        <p>Para visualizar la comparativa entre municipios, por favor seleccione:</p>
        <ul style="text-align: left; margin: 1rem 0; display: inline-block;">
          <li>Una vigencia</li>
          <li>Los departamentos de los municipios</li>
          <li>Los dos municipios que desea comparar</li>
        </ul>
        <p><strong>Nota:</strong> Los gráficos y tablas comparativas se mostrarán una vez realice las selecciones.</p>
      </div>
    </p-card>
  </div>

  <!-- Loading indicator while fetching comparative data -->
  <div class="loading-section" *ngIf="isLoadingComparativeData && townSelected && townSelected2">
    <p-card class="loading-card">
      <div class="loading-content" style="text-align: center; padding: 3rem;">
        <p-progress-spinner 
          styleClass="w-4rem h-4rem" 
          strokeWidth="4" 
          fill="#ddd" 
          animationDuration=".5s">
        </p-progress-spinner>
        <h3 style="margin-top: 1.5rem; color: #666;">Cargando datos comparativos</h3>
        <p>Consultando información de los municipios seleccionados...</p>
        <div class="loading-details" style="margin-top: 1rem; font-size: 0.9rem; color: #888;">
          <p>• {{ getSelectedMunicipalityName(1) }}</p>
          <p>• {{ getSelectedMunicipalityName(2) }}</p>
          <p>• Vigencia {{ getSelectedVigenciaName() }}</p>
        </div>
      </div>
    </p-card>
  </div>

  <!-- Chart section -->
  <div class="graphics-section" *ngIf="townSelected && townSelected2 && !isLoadingComparativeData">
    <div class="dual-chart-container" style="display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem; width: 100%;">
      <!-- First Chart - Municipality 1 -->
      <div class="chart-column">
        <p-card class="chart-card">
          <ng-template pTemplate="header">
            <div style="text-align: center; width: 100%; display: flex; flex-direction: column; align-items: center;">
              <h3 class="chart-title">{{ getSelectedMunicipalityName(1) }} - Distribución por conceptos principales</h3>
            </div>
          </ng-template>
          <div class="chart-container" style="position: relative; height: 400px; width: 100%;">
            <canvas id="barChart" style="max-width: 100%; max-height: 100%;"></canvas>
          </div>
        </p-card>
      </div>

      <!-- Second Chart - Municipality 2 -->
      <div class="chart-column">
        <p-card class="chart-card">
          <ng-template pTemplate="header">
            <div style="text-align: center; width: 100%; display: flex; flex-direction: column; align-items: center;">
              <h3 class="chart-title">{{ getSelectedMunicipalityName(2) }} - Distribución por conceptos principales</h3>
            </div>
          </ng-template>
          <div class="chart-container" style="position: relative; height: 400px; width: 100%;">
            <canvas id="barChart2" style="max-width: 100%; max-height: 100%;"></canvas>
          </div>
        </p-card>
      </div>
    </div>
  </div>

  <!-- Data table section -->
  <div class="table-section" *ngIf="townSelected && townSelected2 && !isLoadingComparativeData">
    <div class="dual-table-container" style="display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem; width: 100%;">
      <!-- First Municipality Table -->
      <div class="table-column">
        <p-card class="table-card">
          <ng-template pTemplate="header">
            <div style="text-align: center; width: 100%; display: flex; flex-direction: column; align-items: center;">
              <h3 class="table-title">{{ getSelectedMunicipalityName(1) }} - Vigencia {{ getSelectedVigenciaName() }}</h3>              
            </div>
          </ng-template>
          <p-treetable #treeTable
                       [value]="treeTableData" 
                       dataKey="key" 
                       [scrollable]="true"
                       [scrollHeight]="treeTableData && treeTableData.length > 5 ? '400px' : 'auto'"
                       [styleClass]="'sgp-treetable'"
                       [tableStyle]="{'min-width':'15rem'}"
                       *ngIf="treeTableData.length > 0">
            <ng-template pTemplate="header">
              <tr>
                <th class="table-header concept-header" style="width: 70%;">Concepto</th>
                <th class="table-header vigencia-header" style="width: 30%; text-align: right;">
                  Valor
                </th>
              </tr>
            </ng-template>
            <ng-template pTemplate="body" let-rowNode let-rowData="rowData">
              <tr>
                <td class="concept-cell">
                  <p-treeTableToggler [rowNode]="rowNode"></p-treeTableToggler>
                  <strong>{{ rowData.concepto }}</strong>
                </td>
                <td class="vigencia-cell">
                  {{ rowData.vigencia | numberFormat }}
                </td>
              </tr>
            </ng-template>
            <ng-template pTemplate="footer">
              <tr class="total-row">
                <td class="concept-cell"><strong>Total General</strong></td>
                <td class="vigencia-cell">
                  <strong>{{ getTreeTableYearTotal() | numberFormat }}</strong>
                </td>
              </tr>
            </ng-template>
          </p-treetable>
          
          <!-- Export button for first table -->
          <div class="table-buttons" *ngIf="treeTableData.length > 0">
            <button pButton type="button" 
                    icon="pi pi-file-excel" 
                    label="Exportar Excel" 
                    class="p-button-primary p-button-sm"
                    (click)="exportToExcel()">
            </button>
          </div>
        </p-card>
      </div>

      <!-- Second Municipality Table -->
      <div class="table-column">
        <p-card class="table-card">
          <ng-template pTemplate="header">
            <div style="text-align: center; width: 100%; display: flex; flex-direction: column; align-items: center;">
              <h3 class="table-title">{{ getSelectedMunicipalityName(2) }} - Vigencia {{ getSelectedVigenciaName() }}</h3>              
            </div>
          </ng-template>
          <p-treetable #treeTable2
                       [value]="treeTableData2" 
                       dataKey="key" 
                       [scrollable]="true"
                       [scrollHeight]="treeTableData2 && treeTableData2.length > 5 ? '400px' : 'auto'"
                       [styleClass]="'sgp-treetable'"
                       [tableStyle]="{'min-width':'15rem'}"
                       *ngIf="treeTableData2.length > 0">
            <ng-template pTemplate="header">
              <tr>
                <th class="table-header concept-header" style="width: 70%;">Concepto</th>
                <th class="table-header vigencia-header" style="width: 30%; text-align: right;">
                  Valor
                </th>
              </tr>
            </ng-template>
            <ng-template pTemplate="body" let-rowNode let-rowData="rowData">
              <tr>
                <td class="concept-cell">
                  <p-treeTableToggler [rowNode]="rowNode"></p-treeTableToggler>
                  <strong>{{ rowData.concepto }}</strong>
                </td>
                <td class="vigencia-cell">
                  {{ rowData.vigencia | numberFormat }}
                </td>
              </tr>
            </ng-template>
            <ng-template pTemplate="footer">
              <tr class="total-row">
                <td class="concept-cell"><strong>Total General</strong></td>
                <td class="vigencia-cell">
                  <strong>{{ getTreeTableYearTotal2() | numberFormat }}</strong>
                </td>
              </tr>
            </ng-template>
          </p-treetable>
          
          <!-- Export button for second table -->
          <div class="table-buttons" *ngIf="treeTableData2.length > 0">
            <button pButton type="button" 
                    icon="pi pi-file-excel" 
                    label="Exportar Excel" 
                    class="p-button-primary p-button-sm"
                    (click)="exportToExcel2()">
            </button>
          </div>
        </p-card>
      </div>
    </div>

    <!-- Shared Notes -->
    <div class="shared-table-notes">
      <h4>NOTAS</h4>
      <p>(1) Cifras en pesos corrientes.</p>
      <p>(2) Comparativa entre municipios para la vigencia {{ getSelectedVigenciaName() }}.</p>
    </div>
  </div>
</div>
