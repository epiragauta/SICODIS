<div class="sicodis-container">

  <!-- Breadcrumb -->
  <div class="card flex justify-center">
    <p-breadcrumb [model]="items" [home]="home" />
  </div>

  <!-- Popups para Diccionario y Siglas -->
  <app-info-popup 
    [infoText]="diccionarioContent" 
    contentTitle="Diccionario de Conceptos"
    [showPopup]="showDiccionarioPopup"
    (onClose)="closeDiccionarioPopup()">
  </app-info-popup>
  
  <app-info-popup 
    [infoText]="siglasContent" 
    contentTitle="Siglas y Abreviaciones"
    [showPopup]="showSiglasPopup"
    (onClose)="closeSiglasPopup()">
  </app-info-popup>

  <!-- Banner -->
  <div class="gradient-banner">    
    <div class="gradient-overlay"></div>
    <div class="banner-content">
      <h1>SGR Comparativo</h1>
        <p>Consulte y compare información presupuestal y de recaudo entre diferentes entidades territoriales del Sistema General de Regalías.</p>
    </div>
  </div>
  
  <!-- Botones Presupuesto y Recaudo / Plan Bienal de Caja y Recaudo -->
  <div class="view-buttons-section">
    <div class="view-buttons-container">
      <button pButton type="button" 
              [class]="showPresupuestoRecaudoView ? 'p-button-primary' : 'p-button-secondary'" 
              label="Presupuesto y Recaudo" 
              (click)="showPresupuestoRecaudo()">
      </button>
      <button pButton type="button" 
              [class]="showPlanBienalView ? 'p-button-primary' : 'p-button-secondary'" 
              label="Plan Bienal de Caja y Recaudo" 
              (click)="showPlanBienal()">
      </button>
    </div>
  </div>

  <!-- Panel de filtros -->
  <div class="filters-panel">
    <div class="filters-row">
      <div class="p-field bienio-select">
        <p-floatlabel class="w-full md:w-56" variant="on">
          <p-select id="bienio" [options]="bienios" inputId="bienioSelect" [(ngModel)]="selectedBienio"
            optionLabel="label" [showClear]="false" placeholder="Bienio"></p-select>
          <label for="bienioSelect">Bienio</label>
        </p-floatlabel>
      </div>

      <div class="p-field departamento-select">
        <p-floatlabel class="w-full md:w-56" variant="on">
          <p-select id="departamento" [options]="departamentos" inputId="departamentoSelect" [(ngModel)]="selectedDepartamento"
            (onChange)="onDepartmentChange($event)" optionLabel="nombre" [showClear]="false" placeholder="Departamento"></p-select>
          <label for="departamentoSelect">Departamento</label>
        </p-floatlabel>
      </div>

      <div class="p-field municipio-select">
        <p-floatlabel class="w-full md:w-56" variant="on">
          <p-select id="municipio" [options]="municipios" inputId="municipioSelect" [(ngModel)]="selectedMunicipio"
            (onChange)="onMunicipioChange($event)" optionLabel="nombre_municipio" [showClear]="false" placeholder="Municipio" [disabled]="!selectedDepartamento"></p-select>
          <label for="municipioSelect">Municipio</label>
        </p-floatlabel>
      </div>

      <div class="p-field departamento2-select">
        <p-floatlabel class="w-full md:w-56" variant="on">
          <p-select id="departamento2" [options]="departamentos" inputId="departamento2Select" [(ngModel)]="selectedDepartamento2"
            (onChange)="onDepartment2Change($event)" optionLabel="nombre" [showClear]="false" placeholder="Departamento 2"></p-select>
          <label for="departamento2Select">Departamento 2</label>
        </p-floatlabel>
      </div>

      <div class="p-field municipio2-select">
        <p-floatlabel class="w-full md:w-56" variant="on">
          <p-select id="municipio2" [options]="municipios2" inputId="municipio2Select" [(ngModel)]="selectedMunicipio2"
            (onChange)="onMunicipio2Change($event)" optionLabel="nombre_municipio" [showClear]="false" placeholder="Municipio 2" [disabled]="!selectedDepartamento2"></p-select>
          <label for="municipio2Select">Municipio 2</label>
        </p-floatlabel>
      </div>

      <div class="p-field clear-filters">
        <button pButton type="button"
            icon="pi pi-eraser"
            label="Limpiar filtros"
            class="p-button-secondary"
            (click)="clearFilters()">
        </button>
      </div>
    </div>
  </div>

  <!-- Sección de botones Diccionario y Siglas -->
  <div style="display: flex; justify-content: space-between; align-items: center; padding: .1rem 0;">
    <div style="width: 83%;">
      <p class="date-update">Fecha de actualización: junio 30 de 2025</p>
      <p class="date-update">Fecha de corte de recaudo: mayo 30 de 2025</p>
    </div>
    <div style="position: relative; padding-bottom: .25rem;">
      <button pButton type="button" label="Diccionario" class="p-button-secondary" style="margin-right: 1.8rem; width: 96px;"
          (click)="showPopupDiccionario()">
      </button>
      <button pButton type="button" label="Siglas" class="p-button-secondary" style="width: 90px;"
          (click)="showPopupSiglas()">
      </button>
    </div> 
  </div>

  <!-- Informative message when no entities are selected -->
  <div class="info-message-section" *ngIf="!selectedMunicipio || !selectedMunicipio2">
    <p-card class="info-card">
      <div class="info-content" style="text-align: center; padding: 2rem;">
        <i class="pi pi-info-circle" style="font-size: 3rem; color: #2196F3; margin-bottom: 1rem;"></i>
        <h3>Seleccione las entidades territoriales a comparar</h3>
        <p>Para visualizar la comparativa entre entidades territoriales, por favor seleccione:</p>
        <ul style="text-align: left; margin: 1rem 0; display: inline-block;">
          <li>Un bienio</li>
          <li>Los departamentos de las entidades</li>
          <li>Las dos entidades territoriales que desea comparar</li>
        </ul>
        <p><strong>Nota:</strong> Los gráficos y tablas comparativas se mostrarán una vez realice las selecciones.</p>
      </div>
    </p-card>
  </div>

  <!-- Charts section - Solo visible cuando se seleccionan todos los filtros -->
   <div class="graphics-section" *ngIf="showPresupuestoRecaudoView && selectedMunicipio && selectedMunicipio2">
    <h2 class="charts-main-title">Avance del recaudo frente al Presupuesto Bienio  {{selectedBienio.label}}</h2>
    <div class="dual-chart-container" style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; width: 100%;">
      <!-- First Chart - Municipality 1 -->
      <div class="chart-column">
        <p-card class="chart-card">
          <ng-template pTemplate="header">
            <div style="text-align: center; width: 100%; display: flex; flex-direction: column; align-items: center;">
              <h3 class="chart-title">{{ getSelectedMunicipalityName(1) }} </h3>
            </div>
          </ng-template>
          <div class="chart-container" style="position: relative; height: 320px; width: 100%;">
            <p-chart 
              type="bar" 
              [data]="planBienalMunicipio1ChartData" 
              [options]="planBienalMunicipio1ChartOptions"
              width="570px"
              height="300px">
            </p-chart>
          </div>
          <!-- Detalle ingresos corrientes for Presupuesto y recaudo Municipality 1 -->
        <div class="detalle-ingresos-section">
          <h3 class="detalle-title">Detalle ingresos corrientes</h3>
          
          <div class="donut-charts-container">
            <!-- First donut chart -->
            <div class="donut-chart-item">
              <h4 class="donut-chart-title">Presupuesto y recaudo corrientes Asignaciones Directas (25%)</h4>
              <div class="donut-chart-wrapper">
                <p-chart 
                  type="doughnut" 
                  [data]="planBienalMunicipio1DirectasDonutData" 
                  [options]="donutChartOptions"
                  width="265px"
                  height="150px">
                </p-chart>
              </div>
            </div>
            
            <!-- Second donut chart -->
            <div class="donut-chart-item">
              <h4 class="donut-chart-title">Presupuesto y recaudo corrientes Asignación para la Inversión Local</h4>
              <div class="donut-chart-wrapper">
                <p-chart 
                  type="doughnut" 
                  [data]="planBienalMunicipio1LocalDonutData" 
                  [options]="donutChartOptions"
                  width="265px"
                  height="150px">
                </p-chart>
              </div>
            </div>
          </div>
        </div>
        </p-card>        

      </div>

      <!-- Second Chart - Municipality 2 -->
      <div class="chart-column">
        <p-card class="chart-card">
          <ng-template pTemplate="header">
            <div style="text-align: center; width: 100%; display: flex; flex-direction: column; align-items: center;">
              <h3 class="chart-title">{{ getSelectedMunicipalityName(2) }}</h3>
            </div>
          </ng-template>
          <div class="chart-container" style="position: relative; height: 320px; width: 100%;">
            <p-chart 
            type="bar" 
            [data]="planBienalMunicipio2ChartData" 
            [options]="planBienalMunicipio2ChartOptions"
            width="570px"
            height="300px">
          </p-chart>
          </div>
          <!-- Detalle ingresos corrientes for Plan Bienal Municipality 2 -->
        <div class="detalle-ingresos-section">
          <h3 class="detalle-title">Detalle ingresos corrientes</h3>
          
          <div class="donut-charts-container">
            <!-- First donut chart -->
            <div class="donut-chart-item">
              <h4 class="donut-chart-title">Presupuesto y recaudo corrientes Asignaciones Directas (25%)</h4>
              <div class="donut-chart-wrapper">
                <p-chart 
                  type="doughnut" 
                  [data]="planBienalMunicipio2DirectasDonutData" 
                  [options]="donutChartOptions"
                  width="265px"
                  height="150px">
                </p-chart>
              </div>
            </div>
            
            <!-- Second donut chart -->
            <div class="donut-chart-item">
              <h4 class="donut-chart-title">Presupuesto y recaudo corrientes Asignación para la Inversión Local</h4>
              <div class="donut-chart-wrapper">
                <p-chart 
                  type="doughnut" 
                  [data]="planBienalMunicipio2LocalDonutData" 
                  [options]="donutChartOptions"
                  width="265px"
                  height="150px">
                </p-chart>
              </div>
            </div>
          </div>
        </div>
        </p-card>

        
      </div>
    </div>

    <!-- Individual Municipality Tables for Presupuesto y Recaudo -->
    <div class="municipality-tables-section">
      <div class="tables-container" style="overflow-x: auto;">
        <!-- Table for Municipality 1 -->
        <div class="municipality-table-wrapper">
          <div class="table-header">
            <h3 class="municipality-table-title">{{ getSelectedMunicipalityName(1) }}</h3>
          </div>
          
          <div style="overflow-x: auto;">
            <p-table [value]="municipality1TableData" 
                     styleClass="p-datatable-sm municipality-table">
            <ng-template pTemplate="header">
              <tr>
                <th class="asignacion-header">Asignación</th>
                <th class="presupuesto-header">Presupuesto Total</th>
                <th class="corriente-header">Presupuesto Corriente</th>
                <th class="otros-header">Presupuesto Otros</th>
                <th class="recaudo-corriente-header">Recaudo Corriente</th>
                <th class="recaudo-otros-header">Recaudo Otros</th>
                <th class="recaudo-total-header">Recaudo Total</th>
                <th class="avance-iac-header">Avance IAC frente a presupuesto</th>
              </tr>
            </ng-template>
            
            <ng-template pTemplate="body" let-rowData>
              <tr>
                <td class="asignacion-cell">{{rowData.asignacion}}</td>
                <td class="number-cell">{{rowData.presupuesto_total | numberFormat}}</td>
                <td class="number-cell">{{rowData.presupuesto_corriente | numberFormat}}</td>
                <td class="number-cell">{{rowData.presupuesto_otros | numberFormat}}</td>
                <td class="number-cell">{{rowData.recaudo_corriente | numberFormat}}</td>
                <td class="number-cell">{{rowData.recaudo_otros | numberFormat}}</td>
                <td class="number-cell">{{rowData.recaudo_total | numberFormat}}</td>
                <td class="number-cell">{{rowData.avance_iac | numberFormat}}</td>
              </tr>
            </ng-template>
            </p-table>
          </div>
        </div>

        <!-- Table for Municipality 2 -->
        <div class="municipality-table-wrapper">
          <div class="table-header">
            <h3 class="municipality-table-title">{{ getSelectedMunicipalityName(2) }}</h3>
          </div>
          
          <div style="overflow-x: auto;">
            <p-table [value]="municipality2TableData" 
                     styleClass="p-datatable-sm municipality-table">
            <ng-template pTemplate="header">
              <tr>
                <th class="asignacion-header">Asignación</th>
                <th class="presupuesto-header">Presupuesto Total</th>
                <th class="corriente-header">Presupuesto Corriente</th>
                <th class="otros-header">Presupuesto Otros</th>
                <th class="recaudo-corriente-header">Recaudo Corriente</th>
                <th class="recaudo-otros-header">Recaudo Otros</th>
                <th class="recaudo-total-header">Recaudo Total</th>
                <th class="avance-iac-header">Avance IAC frente a presupuesto</th>
              </tr>
            </ng-template>
            
            <ng-template pTemplate="body" let-rowData>
              <tr>
                <td class="asignacion-cell">{{rowData.asignacion}}</td>
                <td class="number-cell">{{rowData.presupuesto_total | numberFormat}}</td>
                <td class="number-cell">{{rowData.presupuesto_corriente | numberFormat}}</td>
                <td class="number-cell">{{rowData.presupuesto_otros | numberFormat}}</td>
                <td class="number-cell">{{rowData.recaudo_corriente | numberFormat}}</td>
                <td class="number-cell">{{rowData.recaudo_otros | numberFormat}}</td>
                <td class="number-cell">{{rowData.recaudo_total | numberFormat}}</td>
                <td class="number-cell">{{rowData.avance_iac | numberFormat}}</td>
              </tr>
            </ng-template>
            </p-table>
          </div>
        </div>
      </div>
    </div>
  </div>  

  <!-- Plan Bienal Charts section - Solo visible cuando se selecciona Plan Bienal view -->
  <div class="graphics-section" *ngIf="showPlanBienalView && selectedMunicipio && selectedMunicipio2">
    <h2 class="charts-main-title">Avance del recaudo frente al Plan Bienal de Caja Bienio {{selectedBienio}}</h2>
    <div class="dual-chart-container" style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; width: 100%;">
      <!-- First Chart - Municipality 1 -->
      <div class="chart-column">
        <p-card class="chart-card">
          <ng-template pTemplate="header">
            <div style="text-align: center; width: 100%; display: flex; flex-direction: column; align-items: center;">
              <h3 class="chart-title">{{ getSelectedMunicipalityName(1) }}</h3>
            </div>
          </ng-template>
          <div class="chart-container" style="position: relative; height: 320px; width: 100%;">
            <p-chart 
            type="bar" 
            [data]="municipio1ChartData" 
            [options]="municipio1ChartOptions"
            width="570px"
            height="300px">
          </p-chart>
          </div>
        </p-card>        
        
      </div>

      <!-- Second Chart - Municipality 2 -->
      <div class="chart-column">
        <p-card class="chart-card">
          <ng-template pTemplate="header">
            <div style="text-align: center; width: 100%; display: flex; flex-direction: column; align-items: center;">
              <h3 class="chart-title">{{ getSelectedMunicipalityName(2) }}</h3>
            </div>
          </ng-template>
          <div class="chart-container" style="position: relative; height: 320px; width: 100%;">
            <p-chart 
            type="bar" 
            [data]="municipio2ChartData" 
            [options]="municipio2ChartOptions"            
            width="570px"
            height="300px">
          </p-chart>
          </div>
        </p-card>        
        
      </div>
    </div>
  </div>  

  <!-- Comparative table section -->
  <div class="table-section" *ngIf="showPlanBienalView && selectedMunicipio && selectedMunicipio2">
    <div class="table-header">
      <h2 class="table-title">Comparativo de Asignaciones por Entidad Territorial</h2>
    </div>
    
    <div style="overflow-x: auto;">
      <p-table [value]="comparativeTableData" 
               styleClass="p-datatable-sm comparative-table">
             
      <!-- Grouped headers -->
      <ng-template pTemplate="header">
        <tr>
          <th rowspan="2" class="entity-header">Entidad</th>
          <th colspan="2" class="group-header directas-header">Asignaciones Directas 20%</th>
          <th colspan="2" class="group-header local-header">Asignación para la Inversión Local</th>
        </tr>
        <tr>
          <!-- Directas 20% sub-headers -->
          <th class="sub-header directas-sub">PBC</th>
          <th class="sub-header directas-sub">Recaudo</th>
          <!-- Local sub-headers -->
          <th class="sub-header local-sub">PBC</th>
          <th class="sub-header local-sub">Recaudo</th>
        </tr>
      </ng-template>
      
      <!-- Data rows -->
      <ng-template pTemplate="body" let-rowData>
        <tr>
          <td class="entity-cell">{{rowData.entidad}}</td>
          <!-- Directas 20% data -->
          <td class="number-cell">{{rowData.directas_pbc | numberFormat}}</td>
          <td class="number-cell">{{rowData.directas_recaudo | numberFormat}}</td>
          <!-- Local data -->
          <td class="number-cell">{{rowData.local_pbc | numberFormat}}</td>
          <td class="number-cell">{{rowData.local_recaudo | numberFormat}}</td>
        </tr>
      </ng-template>
      
      </p-table>
    </div>

    <!-- Export buttons -->
    <div class="table-actions">
      <button pButton type="button" 
              icon="pi pi-file-excel" 
              label="Descargar Consolidado" 
              class="p-button-primary export-btn"
              (click)="downloadConsolidated()">
      </button>
      
      <button pButton type="button" 
              icon="pi pi-calendar" 
              label="Descargar Detalle por Mes" 
              class="p-button-primary export-btn"
              (click)="downloadMonthlyDetail()">
      </button>
    </div>
  </div>

</div>